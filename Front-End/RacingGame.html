<style>
    body{
        background-repeat: no-repeat;
        background-size: 100vw 100vh;
    }
</style>
<script>
    //Fahrzeug wir generiert und Spiel wird gestartet
    let timergame = "";
    let map = [];
    let mapRequest = [];
    let changeMap = true;

    let arrowW = "";
    let arrowA = "";
    let arrowS = "";
    let arrowD = "";

    //Map
    let mapSeachID = 500500;
    let xtiles = 20;
    let ytiles = 7;
    let tilessize = 100;

    //Auto einstellungen
    let xAchse = 0;
    let speed = 0;
    let deg = 0;

    let maxspeed = 0;
    let maxbackspeed = 0;
    let speedcontrol = 0;
    let maxxAchse = 0;
    let xAchseControl = 0;
    let carwidth = 0;
    let carheight = 0;

    //Coin
    let CoinWidth = 25;
    let CoinHeight = 25;

    let Score = 0;
    let GameStatusRunning = true;
    let FirstMap = false;

    function GameStart(){

        //Timer Definieren
        $.getJSON(path + "Back-End/Interfaces/GetCarObject.php?CarID=1&SeesionID=" + getSessionIdFromCookies(), function (data) {

            maxspeed = parseInt(data.maxspeed);
            maxbackspeed = parseInt(data.maxbackspeed);
            speedcontrol = parseInt(data.speedcontrol);
            maxxAchse = parseInt(data.maxxAchse);
            xAchseControl = parseInt(data.xAchseControl);
            carwidth = parseInt(data.carwidth);
            carheight = parseInt(data.carheight);

            $("#MyCar")[0].style.transform = "rotate(0deg)";
            $("#MyCar")[0].style.top = (window.innerHeight - carheight) / 2 + "px";
            $("#MyCar")[0].style.left = (window.innerWidth - carwidth) / 2 + "px";

            $("#MyCar")[0].style.width = carwidth + "px";
            $("#MyCar")[0].style.height = carheight + "px";

            SpaceXAPI();

            clearInterval(timergame);
            timergame = setInterval("step()", 25);
        });
    }
    LoadMap();

    // Game status wird geändert und das PauseMenü kommt
    function ChangeGameStatus(){
        if (GameStatusRunning){
            GameStatusRunning = false;
            $("#PauseMenuTransperent")[0].style.display = "block";
        } else {
            GameStatusRunning = true;
            $("#PauseMenuTransperent")[0].style.display = "none";
        }
    }

    // Generiert auf der Map eine Münze
    function generateCoin() {
        let savearr = [];
        for(let o=1;o<map.length;o++){
            if (map[o] != null){
                savearr.push(o);
            }
        }
        console.log(savearr);

        //$('#img').append("<img src='../Images/Coin.png' alt='coin' class='coins' style='position: absolute; top:" + top + "px; left:" + left + "px; width: "+ CoinWidth +"px  ; height: "+ CoinHeight +"px'>");
    }

    // Checkt op ein Coin getroffen wurde | Funktioniert noch nicht zu 100%
    function CeckHitCoin() {
        if ($( ".coins" ).length > 0){
            let savecar =  $( "#MyCar" )[0];
            for (let i=0;i<$( ".coins" ).length;i++){
                let coin =  $( ".coins" )[i];

                //Checkt ob treffer
                if (parseInt(savecar.style.left) < parseInt(coin.style.left)
                    && parseInt(coin.style.left) < (parseInt(savecar.style.left) + carwidth)
                    && parseInt(savecar.style.top) < parseInt(coin.style.top)
                    && parseInt(coin.style.top) < (parseInt(savecar.style.top) + carheight)) {

                    //Coin wird gelöscht
                    $( ".coins" )[i].remove()
                }
            }

        }
    }


    function step(){
        if (!GameStatusRunning){
            return
        }


        // Eine Neue Fahrgschwindigkeit berechnen
        LookCarControl();

        // Eine neue Fahrtrichtung wird berechnet
        GenerateNewDegre();

        // Eine neue Position wird berechnet
        GenerateNewPosition();

        if(changeMap){
            GenerateMap()
        }

        LockForNewMapModel()


        // Checkt on er ein Coin Berührt, wenn ein ein Coin gibt
        if ($( ".coins" ).length > 0){
            CeckHitCoin();
        }

        // Generate a new coin
        // Aktuelle Chance von: 10% pro Sekunde = timer(50ms) * (1 - 0.99)
        if (getRandom(0,1) > 0.99){
            //generateCoin();
        }

        ScorePoints()

        FirstMap = true;

        // Nur zum testen
        document.getElementById('speedMeter').innerHTML = speed;
        document.getElementById('xAchse').innerHTML = xAchse;
    }

    // Was drückt der Spieler
    document.addEventListener('keydown', function(event) {
        if (event.keyCode === 87) { //Press w
            arrowW = "w";
        }
        else if (event.keyCode === 65) { //Press a
            arrowA = "a";
        }
        else if (event.keyCode === 83) { //Press s
            arrowS = "s";
        }
        else if (event.keyCode === 68) { //Press d
            arrowD = "d";
        }
        else if (event.keyCode === 27) { //Press ESC
            ChangeGameStatus();
        }
    }, true);

    // Was hat er losgelassen
    document.addEventListener('keyup', function(event) {
        if (event.keyCode === 87) { //Press w
            arrowW = "";
        }
        else if (event.keyCode === 65) { //Press a
            arrowA = "";
        }
        else if (event.keyCode === 83) { //Press s
            arrowS = "";
        }
        else if (event.keyCode === 68) { //Press d
            arrowD = "";
        }
    }, true);


    function LookCarControl() {
        //Wenn er "W" gedrückt hat wird er schneller
        if (arrowW === "w"){
            if (speed < 0){
                speed=speed+speedcontrol;
            } else if (speed < 80) {
                speed=speed+speedcontrol/100*66
            } else {
                speed=speed+speedcontrol/100*33
            }
            if (maxspeed < speed){
                speed = maxspeed;
            }

        }

        //Wenn er "s" gedrückt hat wird er langsamer
        if (arrowS === "s"){
            if (speed < 0){
                speed=speed-speedcontrol/100*33
            } else if (speed < 80){
                speed=speed-speedcontrol/100*66*1.7
            } else {
                speed=speed-speedcontrol*2
            }
            if (maxbackspeed > speed){
                speed = maxbackspeed;
            }
        }

        //Wenn er kein "W + S" gedrückt hat wird er auf 8-0km/h gebracht
        if (arrowW !== "w" && arrowS !== "s"){
            if (speed > 0){
                speed=speed-speedcontrol/100*20
                if (speed > -1 && speed < 1){
                    speed = 0
                }
            }
            if (speed < 0){
                speed=speed+speedcontrol/100*20
                if (speed > -1 && speed < 1){
                    speed = 0
                }
            }
        }

        //Wenn er "A" gedrückt hat, lenkt er nach Rechts
        if (arrowA === "a"){
            if (speed > 0){
                if (xAchse > -maxxAchse){
                    if (xAchse > 0){
                        xAchse=xAchse-xAchseControl*3
                    } else {
                        xAchse=xAchse-xAchseControl
                    }
                } else {
                    xAchse = -maxxAchse;
                }
            } else {
                if (xAchse > -maxxAchse){
                    if (xAchse > 0){
                        xAchse=xAchse+xAchseControl*3
                    } else {
                        xAchse=xAchse+xAchseControl
                    }
                } else {
                    xAchse = +maxxAchse;
                }
            }


        }

        //Wenn er "D" gedrückt hat, lenkt er nach links
        if (arrowD === "d"){
            if (speed > 0){
                if (xAchse < maxxAchse){
                    if (xAchse < 0){
                        xAchse=xAchse+xAchseControl*3
                    } else {
                        xAchse=xAchse+xAchseControl
                    }
                } else {
                    xAchse = maxxAchse;
                }
            } else {
                if (xAchse < maxxAchse){
                    if (xAchse < 0){
                        xAchse=xAchse-xAchseControl*3
                    } else {
                        xAchse=xAchse-xAchseControl
                    }
                } else {
                    xAchse = -maxxAchse;
                }
            }

        }

        //Wenn er kein "A + D" gedrückt hat, färt er gerade aus
        if (arrowA !== "a" && arrowD !== "d"){
            if (xAchse !== 0){
                for (let i=0;i<xAchseControl;i++){
                    if (xAchse > 0){
                        xAchse = xAchse - 3
                    } else if (xAchse < 0){
                        xAchse = xAchse + 3
                    }
                }
                if (-5 < xAchse && xAchse < 5){
                    xAchse = 0
                }
            }
        }
    }

    function GenerateNewDegre() {
        // Wenn er sich bewegt und lenkt
        if (xAchse !== 0 && speed !== 0){
            //XAchseControlCalc = maxspeed/maxxAchse*xAchse/speed
            XAchseControlCalc = xAchse;
            if (XAchseControlCalc > 5){
                XAchseControlCalc = 5;
            } else if (XAchseControlCalc < -5){
                XAchseControlCalc = -5;
            }

            deg = XAchseControlCalc + parseInt($( "#MyCar" )[0].style.transform.slice(7));

            //console.log(parseInt(document.getElementById("MyCar").style.transform.slice(7)));
            $( "#MyCar" )[0].style.transform = "rotate("+ deg +"deg)";
        }
    }

    function LoadMap() {
        $.getJSON(path + "Back-End/Maps/map00.json", function (data) {
            data.unshift({mapname: "map00"}, {x: ((window.innerWidth - carwidth) / 2 - (xtiles * tilessize / 2))}, {y: ((window.innerHeight - carheight) / 2 - (ytiles * tilessize / 2))})
            map[500500] = data;
        });
    }

    let oldMaploadcounter = 0

    //mapSeachID 500500
    function GenerateMap() {
        let mapmodel = "";
        let maploadcounter = 0
        let mapLoaded = false;
        let mapFound = false;


        let xi = 500;
        let yi = 500;
        let xs = map[500500][1].x;
        let ys = map[500500][2].y;
        if (xs > 0){
            while ( 0 < xs){
                xs -= (xtiles * tilessize)
                xi--
            }
        } else {
            while ( xs+(xtiles * tilessize) < 0 ){
                xs += (xtiles * tilessize)
                xi++
            }
        }
        if (ys > 0){
            while ( 0 < ys){
                ys -= (ytiles * tilessize)
                yi--
            }
        } else {
            while ( ys+(ytiles * tilessize) < 0 ){
                ys += (ytiles * tilessize)
                yi++
            }
        }

        mapSeachID = xi+""+yi;


        let i=mapSeachID;
        let c=xi;
        let r=yi;

        let carX = parseInt($( "#MyCar" )[0].style.left);
        let carY = parseInt($( "#MyCar" )[0].style.top);
        while (!mapLoaded){
            //console.log(i);
            if (map[i] != null){
                if (-(ytiles*tilessize) <= map[i][2].y && map[i][2].y <= window.innerHeight
                    && -(xtiles*tilessize) <= map[i][1].x && map[i][1].x <= window.innerWidth) {

                    // Auf welcher Map befindet sich das Fahrzeug
                    if (map[i][1].x <= carX && carX <= (map[i][1].x + (tilessize*xtiles))
                        && map[i][2].y <= carY && carY <= (map[i][2].y + (tilessize*ytiles))) {
                        if (FirstMap){
                            CheckhitNotGround(i);
                        }
                    }

                    maploadcounter++
                    let k = 0
                    let counter = 0;
                    let jumps = [
                        0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0,0
                    ];
                    mapmodel += "<div class='mapblock' style='top:"+map[i][2].y+"px ;left:"+map[i][1].x+"px '>"

                    for (let row=0; row<=6; row++){

                        for ( let j=0; j<=19; j++) {
                            k = (row*20)+j+3-counter;
                            if (jumps[j] === row){
                                if (map[i][k] != null){
                                    mapmodel += "<img class='tiles' style='width: " + 100 * map[i][k].x + "px;height: " + 100 * map[i][k].y + "px;top: " + 100 * row + "px;left: " + 100 * j + "px' id='"+ i + "" + k + "' src='" + map[i][k].src + "'>";

                                    for ( let m=0; m<map[i][k].x; m++) {
                                        jumps[j+m] = jumps[j+m] + parseInt(map[i][k].y);
                                    }
                                }
                            } else {
                                counter++
                            }
                        }
                    }

                    mapmodel += "</div>";


                }
            }

            if (map[NewMapModelID(i,"x++")] != null){
                if (map[NewMapModelID(i,"x++")][1].x < window.innerWidth){
                    i = NewMapModelID(i,"x++");
                    c++
                    //console.log("1",i,c,r)
                } else {
                    c = xi;
                    r++
                    i = c+""+r;
                    //console.log("2",i,c,r)
                }
            } else {
                //console.log(c-xi)
                if (window.innerWidth < xtiles * tilessize * (c-xi)){
                    c = xi;
                    r++
                    i = c+""+r;
                    //console.log("3",i,c,r)
                }
                c++
                //console.log("10",i,c,r)
            }
            if (map[i] != null) {
                if (map[i][2].y > window.innerHeight) {
                    mapLoaded = true;
                    //console.log("4",i,c,r)
                }
            } else {
                //console.log(r-yi);
                if (window.innerHeight < ytiles * tilessize * (r-yi)){
                    mapLoaded = true;
                    //console.log("5",i,c,r)
                }
            }
        }


        if (oldMaploadcounter !== maploadcounter){
            oldMaploadcounter = maploadcounter
            //console.log("Map Loaded:" ,maploadcounter);
        }

        changeMap = false
        document.getElementById("Playground").innerHTML = mapmodel;
    }

    function GenerateNewPosition(){
        if (speed !== 0){
            let positioncontrol = 10;
            let top,left;
            deg = parseInt($("#MyCar")[0].style.transform.slice(7));

            deg = deg%360;

            if (deg < 0){
                deg = -deg;
                deg= 360 - deg;
            }

            pixel = (deg%90)/0.9;

            if ((deg) < 90){
                top = (positioncontrol*speed/100)*((100-pixel)/100);
                left = -(positioncontrol*speed/100)*(pixel/100);
            } else if ((deg) < 180){
                left = -(positioncontrol*speed/100)*((100-pixel)/100);
                top = -((positioncontrol*speed/100)*(pixel/100));
            } else if ((deg) < 270){
                top = -(positioncontrol*speed/100)*((100-pixel)/100);
                left = (positioncontrol*speed/100)*(pixel/100);
            } else{
                left =  (positioncontrol*speed/100)*((100-pixel)/100);
                top = ((positioncontrol*speed/100)*(pixel/100));
            }

            map.forEach((value,i) => {
                map[i][1].x = Math.floor(map[i][1].x + left);
                map[i][2].y = Math.floor(map[i][2].y + top);
                changeMap = true
            })
        }
    }

    function ExitGame(){
        clearInterval(timergame);
        GetMenuPage();
    }

    function LockForNewMapModel(){
        let carX = parseInt($( "#MyCar" )[0].style.left);
        let carY = parseInt($( "#MyCar" )[0].style.top);
        map.forEach((value,i) => {
            if (map[i][1].x <= carX && carX <= (map[i][1].x + (tilessize*xtiles))
                && map[i][2].y <= carY && carY <= (map[i][2].y + (tilessize*ytiles))) {

                numberarr = i.toString().split('');

                let xi = parseInt(numberarr[0] + numberarr[1] + numberarr[2]);
                let yi = parseInt(numberarr[3] + numberarr[4] + numberarr[5]);
                let xisave = "";
                let yisave = "";


                //Up
                yisave = yi - 1;
                if (map[xi + "" + yisave] == null){
                    LookforMapRequest(xi + "" + yisave);
                }

                //Right
                xisave = xi + 1;
                if (map[xisave + "" + yi] == null){
                    LookforMapRequest(xisave + "" + yi);
                }

                //Down
                yisave = yi + 1;
                if (map[xi + "" + yisave] == null){
                    LookforMapRequest(xi + "" + yisave);
                }

                //Left
                xisave = xi - 1;
                if (map[xisave + "" + yi] == null){
                    LookforMapRequest(xisave + "" + yi);
                }

                //Up-Right
                yisave = yi - 1
                xisave = xi + 1;
                if (map[xisave + "" + yisave] == null){
                    LookforMapRequest(xisave + "" + yisave);
                }

                //Down-Right
                yisave = yi + 1;
                xisave = xi + 1;
                if (map[xisave + "" + yisave] == null){
                    LookforMapRequest(xisave + "" + yisave);
                }

                //Down-Left
                yisave = yi + 1;
                xisave = xi - 1;
                if (map[xisave + "" + yisave] == null){
                    LookforMapRequest(xisave + "" + yisave);
                }

                //Up-Left
                yisave = yi - 1
                xisave = xi - 1;
                if (map[xisave + "" + yisave] == null){
                    LookforMapRequest(xisave + "" + yisave);
                }

                x = tilessize * xtiles;
                y = tilessize * ytiles;

            }
        })
    }

    // Eine Map Fehlt?, schaut welche map gesendet werden soll.
    function LookforMapRequest(mapid) {
        if (mapRequest.includes(mapid)){
            return
        }

        numberarr = mapid.toString().split('');

        let xi = parseInt(numberarr[0] + numberarr[1] + numberarr[2]);
        let yi = parseInt(numberarr[3] + numberarr[4] + numberarr[5]);
        let xisave = "";
        let yisave = "";
        let requestText = "";


        //Up
        yisave = yi - 1;
        if (map[xi + "" + yisave] != null){
            requestText += "up="+map[xi + "" + yisave][0].mapname+"&";
        }

        //Right
        xisave = xi + 1;
        if (map[xisave + "" + yi] != null){
            requestText += "right="+map[xisave + "" + yi][0].mapname+"&";
        }

        //Down
        yisave = yi + 1;
        if (map[xi + "" + yisave] != null){
            requestText += "down="+map[xi + "" + yisave][0].mapname+"&";
        }

        //Left
        xisave = xi - 1;
        if (map[xisave + "" + yi] != null){
            requestText += "left="+map[xisave + "" + yi][0].mapname+"&";
        }

        mapRequest.push(mapid);

        requestText += "newmapid="+mapid;

        $.getJSON(path + "Back-End/Interfaces/GetNewMapModel.php?"+requestText, function (data) {
            let mapname = data.mapname;
            let mapid = parseInt(data.mapid);
            let request = data.maprequest;

            let numberarr = mapid.toString().split('');
            let xi = parseInt(numberarr[0] + numberarr[1] + numberarr[2]);
            let yi = parseInt(numberarr[3] + numberarr[4] + numberarr[5]);

            if (request === "up"){
                yi--
            } else if (request === "right"){
                xi++
            } else if (request === "down"){
                yi++
            } else {
                xi--
            }

            if (map[xi +""+ yi] == null){
                mapRequest.forEach((value,i) => {
                    //console.log(value , mapid);
                    if (value == mapid){
                        //console.log(value , xi +""+ yi);
                        mapRequest.splice(i,1);
                    }
                })
            }

            let mx = map[xi +""+ yi][1].x;
            let my = map[xi +""+ yi][2].y;

            if (request === "up"){
                my += ytiles * tilessize
            } else if (request === "right"){
                mx -= xtiles * tilessize
            } else if (request === "down"){
                my -= ytiles * tilessize
            } else {
                mx += xtiles * tilessize
            }

            delete data.mapname;
            delete data.mapid;
            delete data.maprequest;

            data = Object.values(data);

            data.unshift({mapname: mapname}, {x: mx}, {y: my})

            map[mapid] = data;
            //console.log("New Map Tile", mapid);
            changeMap = true;
        })
    }

    function CheckhitNotGround(i) {
        let rect2 = $( "#MyCar" )[0].getBoundingClientRect();

        let k = 0
        let counter = 0;
        let jumps = [
            0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0,0
        ];
        for (let row=0; row<=6; row++){

            for ( let j=0; j<=19; j++) {
                k = (row*20)+j+3-counter;
                if (jumps[j] === row){
                    let rect1 = $( "#"+i+""+k )[0].getBoundingClientRect();

                    if (rect1.left < rect2.left + rect2.width &&
                        rect1.left + rect1.width > rect2.left &&
                        rect1.top < rect2.top + rect2.height &&
                        rect1.top + rect1.height > rect2.top) {
                        if (map[i][k].collison){
                            console.log("hit",i,k);
                            GameFinished();
                        }
                    }



                    for ( let m=0; m<map[i][k].x; m++) {
                        jumps[j+m] = jumps[j+m] + parseInt(map[i][k].y);
                    }
                } else {
                    counter++
                }
            }
        }
    }

    function ScorePoints() {
        Score += speed / 100;


        $("#Points").text( (Math.floor(Score*100))/100 );
    }

    function GameFinished() {
        clearInterval(timergame);
        $( "body" ).css( "background-image", "none" );
        $.getJSON(path + "Back-End/Interfaces/SavePoints.php?Points="+(Math.floor(Score*100))/100+"&SeesionID=" + getSessionIdFromCookies(), function (data) {
            ExitGame();
        });

    }

    // SpaceX REST API
    function SpaceXAPI(){
        $.getJSON("https://api.spacexdata.com/v5/launches/latest", function (data) {
            $( "body" ).css( "background-image", "url("+data.links.patch.small+")" );
        });
    }

</script>
<div id="test">
<!--    position: relative;-->
<!--    z-index: 6;-->
<!--    width: 100px;-->
<!--    height: 100px;-->
<!--    background-color: black;-->
<!--    top: 849px;-->
<!--    left: 756px;-->
</div>

<div id="Playground">

</div>

<img id="MyCar" src="../Images/Car_Police01.png">

<div id="divPoints">
    <p>Punkte:</p>
    <p id="Points">0</p>
</div>

<div id="Tempomat">
    <p id="speedMeter"></p>
    <br>
    <p id="xAchse"></p>
</div>

<div id="img">
</div>

<div id="PauseMenuTransperent">
    <div id="PauseMenu">
        <h3>Spiel wurde Pausiert</h3>
        <br>
        <br>
        <br>
        <br>
        <button onClick="ChangeGameStatus()">
            Weiter
        </button>
        <button onClick="ExitGame()">
            Exit
        </button>
    </div>
</div>
<script>
    GameStart();
</script>